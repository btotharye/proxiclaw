#!/bin/bash
# OpenClaw Configuration Backup Script
# Automatically generated by Ansible

set -e

BACKUP_DIR="{{ openclaw_backup_dir }}"
OPENCLAW_DIR="/home/{{ ansible_user }}/.openclaw"
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")

cd "$BACKUP_DIR"

echo "[$(date)] Starting OpenClaw backup..."

# Create config directory structure
mkdir -p config/agents
mkdir -p config/devices
mkdir -p workspace-metadata

# Backup main configuration
if [ -f "$OPENCLAW_DIR/openclaw.json" ]; then
    cp "$OPENCLAW_DIR/openclaw.json" config/openclaw.json
    echo "✓ Backed up openclaw.json"
fi

# Backup device pairing info (safe - no secrets)
if [ -f "$OPENCLAW_DIR/devices/paired.json" ]; then
    cp "$OPENCLAW_DIR/devices/paired.json" config/devices/paired.json
    echo "✓ Backed up device pairing info"
fi

# Backup workspace .cursorrules files (your AI guardrails)
if [ -d "$OPENCLAW_DIR/workspace" ]; then
    find "$OPENCLAW_DIR/workspace" -name ".cursorrules" -type f | while read -r rules_file; do
        # Get relative path from workspace dir
        rel_path="${rules_file#$OPENCLAW_DIR/workspace/}"
        project_name=$(echo "$rel_path" | cut -d'/' -f1)
        
        mkdir -p "workspace-metadata/$project_name"
        cp "$rules_file" "workspace-metadata/$project_name/.cursorrules"
        echo "✓ Backed up .cursorrules for $project_name"
    done
fi

# Create backup manifest
cat > backup-manifest.json <<EOF
{
  "timestamp": "$TIMESTAMP",
  "openclaw_version": "$(docker exec openclaw-openclaw-gateway-1 openclaw --version 2>/dev/null || echo 'unknown')",
  "backup_items": [
    "openclaw.json",
    "devices/paired.json",
    "workspace .cursorrules files"
  ]
}
EOF

# Git commit if there are changes
if [ -n "$(git status --porcelain)" ]; then
    git add .
    git commit -m "Backup: $TIMESTAMP"
    echo "✓ Committed changes"
    
    # Try to push if remote is configured
    if git remote get-url origin >/dev/null 2>&1; then
        if git push origin main 2>/dev/null; then
            echo "✓ Pushed to remote repository"
        else
            echo "⚠ Could not push to remote (may need SSH key setup)"
        fi
    fi
else
    echo "✓ No changes to backup"
fi

echo "[$(date)] Backup completed successfully"
