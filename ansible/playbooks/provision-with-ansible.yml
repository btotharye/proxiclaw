---
# Alternative: Provision VM directly with Ansible instead of Terraform
# This playbook uses the Proxmox Ansible module
# Requires: ansible-galaxy collection install -r requirements.yml
#
# Configure Proxmox connection and VM settings in:
#   ansible/inventory/group_vars/all.yml
# (see all.yml.example for the required variables)

- name: Provision VM on Proxmox with Ansible
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Create VM from template
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vm_id }}"
        name: "{{ vm_name }}"
        clone: "{{ vm_template }}"
        full: true
        storage: "{{ vm_storage }}"
        timeout: 300
      register: vm_created

    - name: Configure VM resources
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vm_id }}"
        name: "{{ vm_name }}"
        cores: "{{ vm_cores }}"
        memory: "{{ vm_memory }}"
        update: true

    - name: Configure cloud-init
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vm_id }}"
        ciuser: "{{ ansible_user | default('ubuntu') }}"
        sshkeys: "{{ lookup('file', ssh_public_key_file | default('~/.ssh/id_rsa.pub')) }}"
        ipconfig:
          ipconfig0: "ip=dhcp"
        update: true

    - name: Start VM
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vm_id }}"
        state: started

    - name: Wait for VM IP address to become available
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vm_id }}"
      register: vm_info
      until: vm_info.msg is defined and vm_info.msg.ip is defined
      retries: 30
      delay: 10

    - name: Display VM information
      debug:
        msg:
          - "VM created successfully!"
          - "VM ID: {{ vm_id }}"
          - "VM Name: {{ vm_name }}"
          - "Node: {{ proxmox_node }}"
          - "Check Proxmox console for IP address if not shown below"
          - "VM IP: {{ vm_info.msg.ip | default('check-proxmox-console') }}"

    - name: Add VM to in-memory inventory for subsequent configuration
      add_host:
        name: "{{ vm_name }}"
        groups: openclaw
        ansible_host: "{{ vm_info.msg.ip | default(omit) }}"
        ansible_user: "{{ ansible_user | default('ubuntu') }}"
        ansible_ssh_private_key_file: "{{ ansible_ssh_private_key_file | default('~/.ssh/id_rsa') }}"

# Follow up with full system configuration
- name: Configure provisioned VM
  hosts: openclaw
  become: true
  gather_facts: true

  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300
        delay: 10

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

  roles:
    - common
    - docker
    - openclaw
    - openclaw-backup

  post_tasks:
    - name: Display deployment information
      debug:
        msg:
          - "OpenClaw deployment completed!"
          - "Access your application at: http://{{ ansible_facts['default_ipv4']['address'] }}:{{ openclaw_port }}"
          - "Installation directory: {{ openclaw_install_dir }}"

