---
# System configuration playbook
- name: Configure Ubuntu system
  hosts: openclaw
  become: true
  gather_facts: true

  tasks:
    - name: Update all packages
      apt:
        upgrade: dist
        update_cache: yes
        cache_valid_time: 3600

    - name: Install essential packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - git
          - wget
          - vim
          - htop
          - net-tools
          - unzip
          - python3
          - python3-pip
        state: present

    - name: Set timezone
      timezone:
        name: "{{ timezone }}"

    - name: Configure UFW firewall
      when: ufw_enabled
      block:
        - name: Install UFW
          apt:
            name: ufw
            state: present

        - name: Allow SSH through firewall
          ufw:
            rule: allow
            port: "22"
            proto: tcp

        - name: Allow configured ports
          ufw:
            rule: allow
            port: "{{ item }}"
            proto: tcp
          loop: "{{ ufw_allow_ports }}"

        - name: Enable UFW
          ufw:
            state: enabled
            policy: deny
            direction: incoming

    - name: Configure automatic security updates
      apt:
        name:
          - unattended-upgrades
          - update-notifier-common
        state: present

    - name: Enable automatic updates
      copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";
          APT::Periodic::AutocleanInterval "7";

    - name: Set hostname
      hostname:
        name: "{{ vm_name | default('openclaw-vm') }}"
